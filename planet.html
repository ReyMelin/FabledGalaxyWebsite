<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="description" content="Explore this world in the Fabled Galaxy - a collaborative world-building universe.">
    <title>Planet | Fabled Galaxy</title>
    
    <!-- Critical CSS to prevent layout shift -->
    <style>
        :root{--color-bg-dark:#0a0a0f;--color-text:#e8e6f0;--color-text-dim:#a8a5b5;--font-display:'Cinzel',Georgia,serif;--font-body:'Quicksand',system-ui,sans-serif}
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        body{background-color:var(--color-bg-dark);color:var(--color-text);font-family:var(--font-body);line-height:1.6}
        .starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background:radial-gradient(ellipse at center,#1a1a2e 0%,#0a0a0f 100%)}
        .planet-page{min-height:100vh}
        .planet-nav{position:fixed;top:0;left:0;right:0;padding:1rem 2rem;z-index:100;min-height:60px}
        .planet-loading{min-height:400px;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .planet-hero{display:grid;grid-template-columns:300px 1fr;gap:2rem;min-height:300px}
        .planet-image-container{min-height:200px;aspect-ratio:1}
        .planet-name{font-family:var(--font-display);font-size:clamp(2rem,5vw,3rem);min-height:1.2em}
        .planet-section{min-height:100px}
        .site-nav{position:fixed;top:0;left:0;right:0;padding:1rem 2rem;z-index:100;background:linear-gradient(180deg,rgba(10,10,15,0.95),transparent);display:flex;justify-content:space-between;align-items:center}
        .nav-links{display:flex;gap:2rem}
        .nav-links a{color:var(--color-text-dim);text-decoration:none;font-size:1rem}
    </style>
    
    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- Preload critical images -->
    <link rel="preload" as="image" href="Imgs/fabled-galaxy-header-optimized.webp" type="image/webp">
</head>
<body>
    <!-- Starfield Background -->
    <div class="starfield" id="starfield"></div>
    
    <!-- Floating Particles -->
    <div class="particles" id="particles"></div>

    <!-- Navigation -->
    <nav class="site-nav">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="gallery.html">Gallery</a>
            <a href="create-fable.html">Create</a>
            <a href="about.html">About</a>
        </div>
        <div id="auth-container" class="auth-container">
            <!-- Auth UI will be injected here -->
        </div>
    </nav>

    <!-- Main Content -->
    <main class="planet-page">
        <!-- Loading State -->
        <div class="planet-loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Traveling to planet...</p>
        </div>

        <!-- Not Found State -->
        <div class="planet-not-found" id="not-found" style="display: none;">
            <span class="not-found-icon">üåë</span>
            <h2>Planet Not Found</h2>
            <p>This world may have been lost to the void, or the coordinates are incorrect.</p>
            <a href="gallery.html" class="btn btn-primary">
                <span class="btn-icon">üåå</span>
                Return to Galaxy
            </a>
        </div>

        <!-- Planet Content -->
        <article class="planet-content" id="planet-content" style="display: none;">
            <!-- Hero Section -->
            <header class="planet-hero">
                <div class="planet-image-container" id="planet-image">
                    <!-- Image or fallback will be inserted here -->
                </div>
                <div class="planet-hero-info">
                    <div class="planet-type-badge" id="planet-type-badge">
                        <!-- Type badge inserted here -->
                    </div>
                    <h1 class="planet-name" id="planet-name">Planet Name</h1>
                    <p class="planet-creator">Created by <span id="creator-name">Creator</span></p>
                    <div class="planet-meta">
                        <span class="meta-item" id="collab-status">üîí Locked</span>
                        <span class="meta-item" id="created-date">Created: Date</span>
                    </div>
                    <div class="planet-actions">
                        <button class="btn btn-secondary btn-small" id="share-btn" title="Share this planet">
                            üì§ Share
                        </button>
                        <button class="btn btn-secondary btn-small mod-only" id="delete-btn" title="Delete planet" style="display: none;">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            </header>

            <!-- Description -->
            <section class="planet-section">
                <h2><span class="section-icon">üåç</span> About This World</h2>
                <div class="section-content">
                    <p id="planet-description">Description goes here...</p>
                </div>
            </section>

            <!-- Civilization -->
            <section class="planet-section" id="section-civilization" style="display: none;">
                <h2><span class="section-icon">üë•</span> People & Civilization</h2>
                <div class="section-content">
                    <div class="lore-block" id="block-inhabitants" style="display: none;">
                        <h3>Inhabitants</h3>
                        <p id="planet-inhabitants"></p>
                        <div class="contributions-list" data-field="inhabitants"></div>
                    </div>
                    <div class="lore-block" id="block-civilization" style="display: none;">
                        <h3>Civilization & Culture</h3>
                        <p id="planet-civilization"></p>
                        <div class="contributions-list" data-field="civilization"></div>
                    </div>
                    <div class="lore-block" id="block-factions" style="display: none;">
                        <h3>Factions & Groups</h3>
                        <p id="planet-factions"></p>
                        <div class="contributions-list" data-field="factions"></div>
                    </div>
                </div>
                <!-- Collaboration Form -->
                <div class="collab-form-container" data-section="civilization" style="display: none;">
                    <div class="collab-form-header">
                        <span class="collab-icon">‚ú®</span>
                        <span>Add to the Fable</span>
                    </div>
                    <form class="collab-form">
                        <select class="collab-field-select" required>
                            <option value="">Choose what to add...</option>
                            <option value="inhabitants">More about Inhabitants</option>
                            <option value="civilization">Culture & Traditions</option>
                            <option value="factions">New Faction or Group</option>
                        </select>
                        <textarea class="collab-input" placeholder="Share your ideas for this world's people..." rows="3" required></textarea>
                        <div class="collab-form-footer">
                            <input type="text" class="collab-name" placeholder="Your name (optional)">
                            <button type="submit" class="btn btn-primary btn-small">Contribute</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Technology -->
            <section class="planet-section" id="section-technology" style="display: none;">
                <h2><span class="section-icon">‚öôÔ∏è</span> Technology</h2>
                <div class="section-content">
                    <div class="tech-level" id="tech-level-badge" style="display: none;">
                        <!-- Tech level badge -->
                    </div>
                    <p id="planet-technology"></p>
                    <div class="contributions-list" data-field="technology"></div>
                </div>
                <!-- Collaboration Form -->
                <div class="collab-form-container" data-section="technology" style="display: none;">
                    <div class="collab-form-header">
                        <span class="collab-icon">‚ú®</span>
                        <span>Add to the Fable</span>
                    </div>
                    <form class="collab-form">
                        <input type="hidden" class="collab-field-select" value="technology">
                        <textarea class="collab-input" placeholder="Describe new inventions, tools, or technological advances..." rows="3" required></textarea>
                        <div class="collab-form-footer">
                            <input type="text" class="collab-name" placeholder="Your name (optional)">
                            <button type="submit" class="btn btn-primary btn-small">Contribute</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Magic -->
            <section class="planet-section" id="section-magic" style="display: none;">
                <h2><span class="section-icon">‚ú®</span> Magic System</h2>
                <div class="section-content">
                    <div class="magic-status" id="magic-status">
                        <!-- Magic status -->
                    </div>
                    <p id="planet-magic"></p>
                    <div class="contributions-list" data-field="magicSystem"></div>
                </div>
                <!-- Collaboration Form -->
                <div class="collab-form-container" data-section="magic" style="display: none;">
                    <div class="collab-form-header">
                        <span class="collab-icon">‚ú®</span>
                        <span>Add to the Fable</span>
                    </div>
                    <form class="collab-form">
                        <input type="hidden" class="collab-field-select" value="magicSystem">
                        <textarea class="collab-input" placeholder="Describe new spells, magical creatures, or arcane phenomena..." rows="3" required></textarea>
                        <div class="collab-form-footer">
                            <input type="text" class="collab-name" placeholder="Your name (optional)">
                            <button type="submit" class="btn btn-primary btn-small">Contribute</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Lore -->
            <section class="planet-section" id="section-lore" style="display: none;">
                <h2><span class="section-icon">üìú</span> Myths & History</h2>
                <div class="section-content">
                    <div class="lore-block" id="block-creation" style="display: none;">
                        <h3>Creation Myth</h3>
                        <p id="planet-creation"></p>
                        <div class="contributions-list" data-field="creationMyth"></div>
                    </div>
                    <div class="lore-block" id="block-legends" style="display: none;">
                        <h3>Legends & Heroes</h3>
                        <p id="planet-legends"></p>
                        <div class="contributions-list" data-field="legends"></div>
                    </div>
                    <div class="lore-block" id="block-history" style="display: none;">
                        <h3>Historical Events</h3>
                        <p id="planet-history"></p>
                        <div class="contributions-list" data-field="history"></div>
                    </div>
                </div>
                <!-- Collaboration Form -->
                <div class="collab-form-container" data-section="lore" style="display: none;">
                    <div class="collab-form-header">
                        <span class="collab-icon">‚ú®</span>
                        <span>Add to the Fable</span>
                    </div>
                    <form class="collab-form">
                        <select class="collab-field-select" required>
                            <option value="">Choose what to add...</option>
                            <option value="creationMyth">Creation Myth addition</option>
                            <option value="legends">New Legend or Hero</option>
                            <option value="history">Historical Event</option>
                        </select>
                        <textarea class="collab-input" placeholder="Share myths, legends, or historical events..." rows="3" required></textarea>
                        <div class="collab-form-footer">
                            <input type="text" class="collab-name" placeholder="Your name (optional)">
                            <button type="submit" class="btn btn-primary btn-small">Contribute</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Actions -->
            <section class="planet-actions">
                <a href="gallery.html" class="btn btn-secondary">
                    <span class="btn-icon">üåå</span>
                    Explore More Worlds
                </a>
                <a href="create-fable.html" class="btn btn-primary">
                    <span class="btn-icon">‚ú¶</span>
                    Create Your Own
                </a>
            </section>
        </article>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p class="footer-tagline">Create a planet. Build a civilization. Add to the galaxy.</p>
                <p class="footer-copyright">¬© 2026 Fabled Galaxy. All rights reserved.</p>
            </div>
        </footer>
    </main>

    <script src="data.js"></script>
    <script type="module" src="supabaseClient.js"></script>
    <script src="script.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Get planet ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const planetId = urlParams.get('id');
            
            // Elements
            const loading = document.getElementById('loading');
            const notFound = document.getElementById('not-found');
            const content = document.getElementById('planet-content');
            const deleteBtn = document.getElementById('delete-btn');
            const shareBtn = document.getElementById('share-btn');
            
            if (!planetId) {
                showNotFound();
                return;
            }
            
            // Wait for Supabase client to be ready
            async function waitForSupabase(timeout = 2000) {
                return new Promise((resolve) => {
                    if (window.loadWorldById) { resolve(true); return; }
                    const start = Date.now();
                    const check = setInterval(() => {
                        if (window.loadWorldById) { clearInterval(check); resolve(true); }
                        else if (Date.now() - start > timeout) { clearInterval(check); resolve(false); }
                    }, 50);
                });
            }
            
            // Load planet data - try Supabase first, then localStorage
            let planet = null;
            
            const supabaseReady = await waitForSupabase();
            if (supabaseReady && window.loadWorldById) {
                try {
                    const world = await window.loadWorldById(planetId);
                    if (world) {
                        // Map Supabase world to expected planet format
                        const colors = ['#7c5bf5', '#00d9ff', '#ff6b9d', '#ffd700', '#4ade80', '#f97316', '#06b6d4', '#a855f7'];
                        const hash = planetId.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
                        planet = {
                            id: world.id,
                            name: world.planet_name,
                            type: world.planet_type,
                            description: world.description,
                            creatorName: world.creator_name || (world.fields?.creator_name) || 'Unknown',
                            collaboration: world.locked ? 'locked' : 'open',
                            createdAt: world.created_at,
                            color: colors[hash % colors.length],
                            ...(world.fields || {})
                        };
                    }
                } catch (e) {
                    console.warn('Supabase load failed, trying localStorage:', e);
                }
            }
            
            // Fallback to localStorage
            if (!planet) {
                planet = FabledGalaxyData.getPlanet(planetId);
            }
            
            if (!planet) {
                showNotFound();
                return;
            }
            
            displayPlanet(planet);
            
            function showNotFound() {
                loading.style.display = 'none';
                notFound.style.display = 'flex';
            }
            
            function displayPlanet(planet) {
                loading.style.display = 'none';
                content.style.display = 'block';
                
                // Update page title
                document.title = `${planet.name} | Fabled Galaxy`;
                
                // Type info
                const typeInfo = FabledGalaxyData.getPlanetTypeInfo(planet.type);
                
                // Hero section
                const imageContainer = document.getElementById('planet-image');
                if (planet.imageData) {
                    imageContainer.innerHTML = `<img src="${planet.imageData}" alt="${planet.name}" width="300" height="300" loading="eager" decoding="async">`;
                } else if (planet.planetImage) {
                    imageContainer.innerHTML = `<img src="${planet.planetImage}" alt="${planet.name}" width="300" height="300" loading="eager" decoding="async">`;
                } else {
                    imageContainer.innerHTML = `<div class="planet-image-fallback" style="background-color: ${planet.color}20;"><span>${typeInfo.emoji}</span></div>`;
                }
                
                document.getElementById('planet-type-badge').innerHTML = `${typeInfo.emoji} ${typeInfo.label}`;
                document.getElementById('planet-name').textContent = planet.name;
                document.getElementById('creator-name').textContent = planet.creatorName;
                document.getElementById('collab-status').textContent = planet.collaboration === 'open' ? 'üîì Open for Collaboration' : 'üîí Locked';
                document.getElementById('created-date').textContent = `Created: ${new Date(planet.createdAt).toLocaleDateString()}`;
                
                // Description
                document.getElementById('planet-description').textContent = planet.description || 'No description provided.';
                
                // Civilization section
                let hasCivilization = false;
                if (planet.inhabitants) {
                    document.getElementById('block-inhabitants').style.display = 'block';
                    document.getElementById('planet-inhabitants').textContent = planet.inhabitants;
                    hasCivilization = true;
                }
                if (planet.civilization) {
                    document.getElementById('block-civilization').style.display = 'block';
                    document.getElementById('planet-civilization').textContent = planet.civilization;
                    hasCivilization = true;
                }
                if (planet.factions) {
                    document.getElementById('block-factions').style.display = 'block';
                    document.getElementById('planet-factions').textContent = planet.factions;
                    hasCivilization = true;
                }
                if (hasCivilization) {
                    document.getElementById('section-civilization').style.display = 'block';
                }
                
                // Technology section
                if (planet.technology || planet.techLevel) {
                    document.getElementById('section-technology').style.display = 'block';
                    if (planet.techLevel) {
                        const techLabels = {
                            'primitive': 'ü™® Primitive / Stone Age',
                            'ancient': 'üèõÔ∏è Ancient / Classical',
                            'medieval': '‚öîÔ∏è Medieval',
                            'renaissance': 'üé® Renaissance',
                            'industrial': 'üè≠ Industrial',
                            'modern': 'üèôÔ∏è Modern',
                            'futuristic': 'üöÄ Futuristic',
                            'post-apocalyptic': 'üíÄ Post-Apocalyptic',
                            'magitech': 'üîÆ‚öôÔ∏è Magitech'
                        };
                        const techBadge = document.getElementById('tech-level-badge');
                        techBadge.textContent = techLabels[planet.techLevel] || planet.techLevel;
                        techBadge.style.display = 'inline-block';
                    }
                    document.getElementById('planet-technology').textContent = planet.technology || '';
                }
                
                // Magic section
                if (planet.magicSystem || planet.magicExists) {
                    document.getElementById('section-magic').style.display = 'block';
                    const magicLabels = {
                        'yes': '‚ú® Magic is a fundamental force',
                        'rare': 'üåü Magic is rare, known to few',
                        'no': '‚ùå No magic exists',
                        'ambiguous': '‚ùì Ambiguous - could be magic or explained'
                    };
                    document.getElementById('magic-status').textContent = magicLabels[planet.magicExists] || '';
                    document.getElementById('planet-magic').textContent = planet.magicSystem || '';
                }
                
                // Lore section
                let hasLore = false;
                if (planet.creationMyth) {
                    document.getElementById('block-creation').style.display = 'block';
                    document.getElementById('planet-creation').textContent = planet.creationMyth;
                    hasLore = true;
                }
                if (planet.legends) {
                    document.getElementById('block-legends').style.display = 'block';
                    document.getElementById('planet-legends').textContent = planet.legends;
                    hasLore = true;
                }
                if (planet.history) {
                    document.getElementById('block-history').style.display = 'block';
                    document.getElementById('planet-history').textContent = planet.history;
                    hasLore = true;
                }
                if (hasLore) {
                    document.getElementById('section-lore').style.display = 'block';
                }
                
                // For open planets, show all sections so collaborators can add content
                if (planet.collaboration === 'open') {
                    document.getElementById('section-civilization').style.display = 'block';
                    document.getElementById('section-technology').style.display = 'block';
                    document.getElementById('section-magic').style.display = 'block';
                    document.getElementById('section-lore').style.display = 'block';
                }
                
                // Moderator actions
                if (FabledGalaxyData.isModerator()) {
                    deleteBtn.style.display = 'inline-flex';
                    deleteBtn.addEventListener('click', () => {
                        if (confirm(`Are you sure you want to delete "${planet.name}"? This cannot be undone.`)) {
                            FabledGalaxyData.deletePlanet(planet.id);
                            window.location.href = 'gallery.html';
                        }
                    });
                }
                
                // Share button
                shareBtn.addEventListener('click', () => {
                    const url = window.location.href;
                    if (navigator.share) {
                        navigator.share({
                            title: `${planet.name} | Fabled Galaxy`,
                            text: `Explore ${planet.name} - ${truncateText(planet.description, 100)}`,
                            url: url
                        });
                    } else if (navigator.clipboard) {
                        navigator.clipboard.writeText(url).then(() => {
                            shareBtn.innerHTML = '‚úì Copied!';
                            setTimeout(() => {
                                shareBtn.innerHTML = 'üì§ Share';
                            }, 2000);
                        });
                    }
                });
                
                // Collaboration features
                if (planet.collaboration === 'open') {
                    setupCollaboration(planet);
                }
                
                // Display existing contributions
                displayContributions(planet);
            }
            
            function setupCollaboration(planet) {
                // Show all collaboration forms
                document.querySelectorAll('.collab-form-container').forEach(container => {
                    container.style.display = 'block';
                    
                    const form = container.querySelector('.collab-form');
                    const section = container.dataset.section;
                    
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        const fieldSelect = form.querySelector('.collab-field-select');
                        const field = fieldSelect.value || fieldSelect.getAttribute('value');
                        const content = form.querySelector('.collab-input').value.trim();
                        const name = form.querySelector('.collab-name').value.trim() || 'Anonymous Traveler';
                        
                        if (!field || !content) {
                            alert('Please fill in all required fields');
                            return;
                        }
                        
                        const result = FabledGalaxyData.addContribution(planet.id, {
                            section,
                            field,
                            content,
                            contributorName: name
                        });
                        
                        if (result) {
                            // Show success feedback
                            const btn = form.querySelector('button[type="submit"]');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '‚úì Added!';
                            btn.disabled = true;
                            
                            // Clear form
                            form.querySelector('.collab-input').value = '';
                            form.querySelector('.collab-name').value = '';
                            if (fieldSelect.tagName === 'SELECT') {
                                fieldSelect.selectedIndex = 0;
                            }
                            
                            // Refresh contributions display
                            displayContributions(result);
                            
                            // Reset button
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }, 2000);
                        } else {
                            alert('Could not add contribution. Please try again.');
                        }
                    });
                });
            }
            
            function displayContributions(planet) {
                const contributions = planet.contributions || [];
                
                // Group contributions by field
                const byField = {};
                contributions.forEach(c => {
                    if (!byField[c.field]) byField[c.field] = [];
                    byField[c.field].push(c);
                });
                
                // Render contributions in their respective containers
                document.querySelectorAll('.contributions-list').forEach(container => {
                    const field = container.dataset.field;
                    const fieldContribs = byField[field] || [];
                    
                    if (fieldContribs.length === 0) {
                        container.innerHTML = '';
                        return;
                    }
                    
                    container.innerHTML = fieldContribs.map(c => `
                        <div class="contribution-item">
                            <p class="contribution-content">${escapeHtml(c.content)}</p>
                            <span class="contribution-meta">
                                ‚Äî ${escapeHtml(c.contributorName)}, ${new Date(c.createdAt).toLocaleDateString()}
                            </span>
                        </div>
                    `).join('');
                });
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function truncateText(text, maxLength) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength).trim() + '...';
            }
        });
    </script>
</body>
</html>
