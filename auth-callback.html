<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Signing you in...</title>
  <meta name="robots" content="noindex" />
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./supabaseClient.js"></script>
</head>
<body>
  <p>Signing you in…</p>

  <script>
    (async () => {
      // Wait until window.sb exists
      await new Promise(r => {
        if (window.sb) return r();
        const t = setInterval(() => {
          if (window.sb) { clearInterval(t); r(); }
        }, 50);
      });

      // ✅ Exchange OAuth code for a session
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (code) {
        const { error } = await window.sb.auth.exchangeCodeForSession(window.location.href);
        if (error) console.warn("exchangeCodeForSession:", error.message);
      }


  (async () => {
    await new Promise(r => {
      if (window.sb) return r();
      const t = setInterval(() => {
        if (window.sb) { clearInterval(t); r(); }
      }, 50);
    });

    // Exchange OAuth code -> session
    const url = new URL(window.location.href);
    if (url.searchParams.get("code")) {
      const { error } = await window.sb.auth.exchangeCodeForSession(window.location.href);
      if (error) console.warn("exchangeCodeForSession:", error.message);
    }

    // Read next
    const nextRaw = url.searchParams.get("next") || "gallery.html";

    // ✅ Safety: only allow redirects to your own origin
    let nextUrl;
    try {
      nextUrl = new URL(nextRaw, window.location.origin);
    } catch {
      nextUrl = new URL("gallery.html", window.location.origin);
    }

    if (nextUrl.origin !== window.location.origin) {
      nextUrl = new URL("gallery.html", window.location.origin);
    }

    window.location.replace(nextUrl.href);
  })();


    })();
  </script>
</body>
</html>
